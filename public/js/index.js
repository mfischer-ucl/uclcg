/*! uclcg 2021-09-27 */

$(document).ready(function(){initFramework();var e=function(e){var t=buttonMap[e.currentTarget.id].jsFile.substring(buttonMap[e.currentTarget.id].jsFile);$.getScript(t).done(function(e,t){$("#setupTabs").data("ui-tabs")&&n(a,e,null,null)}).fail(function(e,t,n){alert("This resource has errors and cannot be loaded. Please notify a system administrator")})};function n(e,n,a,r){var i;if(resetApp(),$("#setupTabs").data("ui-tabs")&&($("#setupTabs").tabs("destroy"),$("#setupTabs").empty(),$("#setupIntro").empty()),i=$("#glRenderTarget").get(0),gl=i.getContext("webgl"),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT),(i=$("#glViewportSmallClone").get(0)).getContext("2d").clearRect(0,0,i.width,i.height),UI.codemirrorInstances)for(t=0;t<UI.codemirrorInstances.length;++t)UI.codemirrorInstances[t].toTextArea();UI.tabs&&($("#implementationTabs").tabs("destroy"),$("#implementationTabs").empty(),$("#implementationTabs").append('<ul id="implementationTabsUL"></ul>')),UI.codemirrorInstances=[],UI={},env={},IO={},$("#implementationTabs").tabs({create:function(t,i){e(n,a,r)},active:0,collapsible:!0})}function a(e,n,a){e=e.replace('initGL(document.getElementById("glViewport"));',""),IO.inputFile=e;try{var i=document.createElement("script");i.type="text/javascript";var s=e;i.appendChild(document.createTextNode(s)),document.body.appendChild(i)}catch(e){return void alert("Your experiment template could not be loaded. Error: "+e.message)}UI=setup(),null!=n&&null!=a&&(UI.renderWidth=n,UI.renderHeight=a),UI.renderWidth&&UI.renderHeight&&(canvas=$("#glRenderTarget").get(0),canvas.width=Math.round(UI.renderWidth),canvas.height=Math.round(UI.renderHeight),initGL($("#glRenderTarget").get(0)),$("#currentResolution").val(canvas.width+"x"+canvas.height)),UI.numFrames||(UI.numFrames=1e3,UI.maxFPS||(UI.maxFPS=24)),$("#maxFramesInput").val(UI.numFrames),UI.showHidden=!1,UI.codemirrorInstances=[],$("#mainTitle").text("UCL Computer Graphics - "+UI.titleLong),$("#viewerRow").show(80,function(){$("#viewerControls").show(80,function(){$("#tabSpace").show(80,function(){for(t=0;t<UI.tabs.length;++t)0!=UI.tabs[t].visible&&($("div#implementationTabs ul").append("<li><a href='#implementationTabs-"+t+"'>"+UI.tabs[t].title+"</a></li>"),$("div#implementationTabs").append("<div id='implementationTabs-"+t+"'><p>"+UI.tabs[t].description+"</p><p class='consoleLike'>"+UI.tabs[t].wrapFunctionStart+"</p><div><textarea id='integratorTextArea-"+t+"'> </textarea></div><p class='consoleLike'>"+UI.tabs[t].wrapFunctionEnd+"</p></div>"));var e=0;for(t=0;t<UI.tabs.length;++t)0!=UI.tabs[t].visible&&("text/javascript"==UI.tabs[t].type?UI.codemirrorInstances.push(CodeMirror.fromTextArea($("#integratorTextArea-"+t).get(0),{mode:"javascript",theme:"base16-dark",lineNumbers:!0,lineWrapping:!0,styleActiveLine:!0,autoCloseBrackets:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!0,viewpointMargin:1/0,extraKeys:{"Alt-F":"find","Ctrl-F":"findPersistent","Ctrl-Q":function(e){e.foldCode(e.getCursor())}},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"]})):UI.codemirrorInstances.push(CodeMirror.fromTextArea($("#integratorTextArea-"+t).get(0),{mode:"x-shader/x-fragment",theme:"base16-dark",lineNumbers:!0,lineWrapping:!0,styleActiveLine:!0,autoCloseBrackets:!0,matchBrackets:!0,indentUnit:4,indentWithTabs:!0,viewpointMargin:1/0,extraKeys:{"Alt-F":"find","Ctrl-F":"findPersistent","Ctrl-Q":function(e){e.foldCode(e.getCursor())}},foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"]})),UI.codemirrorInstances[e].setValue(UI.tabs[t].initialValue),UI.codemirrorInstances[e].refresh(),e+=1);$("#implementationTabs").tabs("refresh"),$("#implementationTabs").tabs({active:0}),r(),env=init(),CODE_CHANGED=!0,invokeCompute(),updateSmallViewerClone()})})})}function r(){for(var e=0,t=0;t<UI.tabs.length;++t)try{var n=$("#"+UI.tabs[t].id).get(0);n&&n.parentElement.removeChild(n);var a=document.createElement("script");a.id=UI.tabs[t].id,a.type=UI.tabs[t].type;var r="";UI.tabs[t].visible?(r=UI.tabs[t].wrapFunctionStart+UI.codemirrorInstances[e].getValue()+UI.tabs[t].wrapFunctionEnd,e+=1):r=UI.tabs[t].wrapFunctionStart+UI.tabs[t].initialValue+UI.tabs[t].wrapFunctionEnd,a.appendChild(document.createTextNode(r)),document.body.appendChild(a)}catch(e){alert("Your function failed to execute. Reported error: "+e.message)}}function i(){r(),CODE_CHANGED&&init(),CODE_CHANGED=!0,invokeCompute(),updateSmallViewerClone()}$(document).bind("keydown",function(e){if((e.ctrlKey||e.metaKey)&&83==e.which)return e.preventDefault(),currentFrame=0,CODE_CHANGED=!0,i(),!1}),env={},UI={},IO={},$("#refreshButton").click(function(){CODE_CHANGED=!0,i()}),$("#menuHelp").click(function(e){e.preventDefault(),$("#helpPage").modal()}),$("#menuLoad").click(function(){$("#loadExperimentInput").trigger("click")}),$("#menuSave").click(function(){var e=generateSetupFunction(UI);""!=e&&(IO.outputFile=replaceSetupFunctionInput(IO.inputFile,e),saveString2File(UI.titleShort+".uclcg",IO.outputFile))}),$("#loadExperimentInput").change(function(){var e,t;e=this.files[0],(t=new FileReader).onload=function(e){n(a,this.result,null,null)},t.readAsText(e)}),$("#reloadSamePage").click(function(e){e.preventDefault(),$("#reloadConfirm").modal()}),$("#confirmPageReload").click(function(){location.reload()}),$("#mainTitle").click(function(e){e.preventDefault(),$("#reloadConfirm").modal()}),$(document).scroll(function(){$(this).scrollTop()>210?$("#floatingPreview").fadeIn():$("#floatingPreview").hide()}),$("#toFirstFrameButton").click(function(){UI.numFrames&&currentFrame>0&&requestStopCB(function(){currentFrame=0,i()})}),$("#toLastFrameButton").click(function(){UI.numFrames&&currentFrame<UI.numFrames&&requestStopCB(function(){currentFrame=UI.numFrames,i()})}),$("#frameForwardButton").click(function(){UI.numFrames&&currentFrame<UI.numFrames&&(currentFrame=Math.min(currentFrame+1,UI.numFrames),i())}),$("#frameBackwardButton").click(function(){UI.numFrames&currentFrame>0&&(currentFrame=Math.max(currentFrame-1,0),i())}),$("#playButton").click(function(){UI.numFrames&&(isPlaying||(requestStop=!1,isPlaying=!0,startPlayback()))}),$("#stopButton").click(function(){UI.numFrames&&isPlaying&&stopPlayback()}),$("#currentFrameInput").on("change paste keyup",function(){var e=$(this).val();if(!isNaN(e)&&""!=e){var t=parseInt(e);UI.numFrames&&t!=currentFrame&&t>=0&&t<=UI.numFrames&&(currentFrame=t,i())}}),$("#maxFramesInput").on("change paste keyup",function(){var e=$(this).val();if(!isNaN(e)&&""!=e){var t=parseInt(e);UI.numFrames&&t>=0&&(UI.numFrames=t)}}),$(document).keyup(function(e){27==e.keyCode&&isPlaying&&stopPlayback()}),$("#decreaseResolutionButton").click(function(){decreaseCanvasResolution(),canvas=$("#glRenderTarget").get(0),$("#currentResolution").val(canvas.width+"x"+canvas.height),currentFrame=0,i()}),$("#increaseResolutionButton").click(function(){increaseCanvasResolution(),canvas=$("#glRenderTarget").get(0),$("#currentResolution").val(canvas.width+"x"+canvas.height),currentFrame=0,i()});class s{constructor(e,t,n,a,r,i,s){this.jsFile=e,this.category=t,this.picture=n,this.niceName=a,this.shortDescription=r,this.author=i,this.hidden=s,this._id=0}}var o,c,u;o="https://uclcg.github.io/uclcg/demos/db.json",c=function(t,n){null!==t&&alert("Something went wrong: "+t),setups=[];for(var a=0;a<n.categories.length;a++){var r="true"===n.hidden[a];(i=new s(n.jsFiles[a],n.categories[a],n.pictures[a],n.niceNames[a],n.shortDescriptions[a],n.authors[a],r))._id=a,setups.push(i)}tabbedSetups=[];for(var i=0;i<setups.length;++i)setups[i].hidden||(tabbedSetups[setups[i].category]||(tabbedSetups[setups[i].category]=[]),tabbedSetups[setups[i].category].push(setups[i]));buttonMap=[];var o=0;Object.keys(tabbedSetups).forEach(function(t){var n=tabbedSetups[t];$("div#setupTabs ul").append("<li><a href='#setupTabs-"+o+"'>"+t+"</a></li>"),$("div#setupTabs").append('<div id="setupTabs-'+o+'"></div>'),$("#setupTabs-"+o).append('<div id="setupRow-'+t+'"class="row display-flex"></div>');for(var a=0;a<n.length;++a){var r=$("#setupRow-"+t),i=n[a].picture,s=n[a].picture.lastIndexOf("/");r.append('<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">\n                                        <div class=" thumbnail">\n                                            <a id="'+t+"_load_"+a+'" href="#" class="loadButton">\n                                            <img src="'+i.substring(0,s+1)+i.substring(s+1)+'" alt="...">\n                                            </a>\n                                            <div class="caption">\n                                                <h3>'+n[a].niceName+"</h3>\n                                                <p>"+n[a].shortDescription+"</p>\n                                            </div>\n                                       </div>\n                                      </div>"),buttonMap[t+"_load_"+a]={id:n[a]._id,jsFile:n[a].jsFile},$(".loadButton").on("click",e)}o+=1}),$("#setupTabs").tabs()},(u=new XMLHttpRequest).open("GET",o,!0),u.responseType="json",u.onload=function(){var e=u.status;c(200===e?null:e,u.response)},u.send()});